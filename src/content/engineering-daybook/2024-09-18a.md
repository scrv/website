---
date: "2024-09-18"
tags: ["Terraform", "Google Cloud"]
---

# Terraform - Error creating WorkloadIdentityPool: Error 409: Requested entity already exists

When running `terraform apply`, in a project that defines a workload identity 
pool and/or a workload identity provider, if the corresponding resource(s) have
been recently deleted—either by using `terraform destroy` or by manually 
removing them—the process will throw the following error:

```bash session
$ terraform apply
...
google_iam_workload_identity_pool.identity_pool: Creating...
╷
│ Error: Error creating WorkloadIdentityPool: googleapi: Error 409: Requested entity already exists
│ 
│   with google_iam_workload_identity_pool.identity_pool,
│   on main.tf line 45, in resource "google_iam_workload_identity_pool" "identity_pool":
│   45: resource "google_iam_workload_identity_pool" "identity_pool" {
│ 
╵ 
```

## Cause

When deleted, both the workload identity pool and workload identity pool 
provider, enter a soft-deletion state, keeping their IDs in use.

> You can undelete a pool for up to 30 days after deletion. After 30 days, 
deletion is permanent. Until a pool is permanently deleted, you cannot reuse its 
name when creating a new workload identity pool.

## Solution

### Recovering a workload identity pool

1. Undelete the workload identity pool.
    ```bash
    gcloud iam workload-identity-pools undelete <WORKLOAD_IDENTITY_POOL_ID> \
        --location="global"
    ```

2. Import the resource to the terraform state.
    ```bash
    terraform import google_iam_workload_identity_pool.<RESOURCE_NAME> \
        <WORKLOAD_IDENTITY_POOL_ID>
    ```

### Recovering a workload identity pool provider

1. Undelete the workload identity pool provider.
    
    ```bash
    gcloud iam workload-identity-pools providers undelete <wORKLOAD_IDENTITY_POOL_PROVIDER_ID> \
        --workload-identity-pool="<WORKLOAD_IDENTITY_POOL_ID>" \
        --location="global"
    ```

2. Import the resource to the terraform state.
    
    ```bash
    terraform import google_iam_workload_identity_pool.<RESOURCE_NAME> \
        <WORKLOAD_IDENTITY_POOL_ID>/<WORKLOAD_IDENTITY_POOL_PROVIDER_ID>
    ```

## Recommendation

Include the `prevent_destroy` attribute in the corresponding resource block.

```terraform
resource "<RESOURCE_TYPE>" "<RESOURCE_NAME>" {
  ...

  lifecycle {
    prevent_destroy = true
  }
}
```

## References

* [https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers](https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers)
* [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/iam_workload_identity_pool#import](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/iam_workload_identity_pool#import)
* [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/iam_workload_identity_pool_provider#import](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/iam_workload_identity_pool_provider#import)
* [https://developer.hashicorp.com/terraform/tutorials/state/resource-lifecycle#prevent-resource-deletion](https://developer.hashicorp.com/terraform/tutorials/state/resource-lifecycle#prevent-resource-deletion)